<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mural da Gratidão</title>
    
    <!-- Tailwind CSS para um design moderno e responsivo -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: Inter e Caveat para um visual amigável -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Caveat:wght@700&family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    
    <!-- Ícones (Feather Icons) -->
    <script src="https://unpkg.com/feather-icons"></script>

    <style>
        /* Estilos personalizados para complementar o Tailwind */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8; /* Um fundo suave e neutro */
        }
        .font-handwriting {
            font-family: 'Caveat', cursive;
        }
        /* Efeito de sombra e rotação sutil para os post-its */
        .post-it {
            box-shadow: 5px 5px 15px rgba(0,0,0,0.1);
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .post-it:hover {
            transform: scale(1.05) rotate(1deg);
            box-shadow: 8px 8px 20px rgba(0,0,0,0.15);
            z-index: 10;
        }
        /* Rotações aleatórias para dar um ar mais orgânico */
        .rotate-1 { transform: rotate(-1deg); }
        .rotate-2 { transform: rotate(1.5deg); }
        .rotate-3 { transform: rotate(-2deg); }
        .rotate-4 { transform: rotate(2.5deg); }
        .rotate-5 { transform: rotate(-0.5deg); }
    </style>
</head>
<body class="antialiased text-slate-800">

    <div id="app" class="container mx-auto p-4 md:p-8 max-w-7xl">

        <!-- Cabeçalho -->
        <header class="text-center mb-8">
            <h1 class="text-4xl md:text-5xl font-bold text-slate-700">Mural da Gratidão</h1>
            <p class="text-slate-500 mt-2">Um espaço para celebrar e agradecer as pequenas e grandes ações.</p>
            <div id="userInfo" class="mt-4 text-xs text-slate-400">
                Carregando seu ID de usuário...
            </div>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <!-- Coluna para adicionar uma nova nota -->
            <div class="lg:col-span-1">
                <form id="gratitudeForm" class="bg-white p-6 rounded-xl shadow-lg sticky top-8">
                    <h2 class="text-2xl font-bold mb-4 flex items-center">
                        <i data-feather="heart" class="mr-2 text-red-500"></i>
                        Deixe seu recado
                    </h2>
                    <div class="space-y-4">
                        <div>
                            <label for="from" class="block text-sm font-medium text-slate-600">De:</label>
                            <input type="text" id="from" name="from" placeholder="Seu nome" class="mt-1 block w-full px-3 py-2 bg-slate-50 border border-slate-300 rounded-md text-sm shadow-sm placeholder-slate-400 focus:outline-none focus:ring-1 focus:ring-sky-500 focus:border-sky-500" required>
                        </div>
                        <div>
                            <label for="to" class="block text-sm font-medium text-slate-600">Para:</label>
                            <input type="text" id="to" name="to" placeholder="Nome do colega ou equipe" class="mt-1 block w-full px-3 py-2 bg-slate-50 border border-slate-300 rounded-md text-sm shadow-sm placeholder-slate-400 focus:outline-none focus:ring-1 focus:ring-sky-500 focus:border-sky-500" required>
                        </div>
                        <div>
                            <label for="message" class="block text-sm font-medium text-slate-600">Sua mensagem de gratidão:</label>
                            <textarea id="message" name="message" rows="5" placeholder="Seja específico! O que a pessoa fez e qual foi o impacto positivo?" class="mt-1 block w-full px-3 py-2 bg-slate-50 border border-slate-300 rounded-md text-sm shadow-sm placeholder-slate-400 focus:outline-none focus:ring-1 focus:ring-sky-500 focus:border-sky-500" required></textarea>
                        </div>
                        <button type="submit" class="w-full bg-sky-500 hover:bg-sky-600 text-white font-bold py-3 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105 flex items-center justify-center">
                            <i data-feather="send" class="mr-2 h-5 w-5"></i>
                            Publicar Agradecimento
                        </button>
                    </div>
                </form>
            </div>

            <!-- Coluna para exibir as notas -->
            <div class="lg:col-span-2">
                <div id="loading" class="text-center py-10">
                    <p class="text-slate-500">Carregando as mensagens de gratidão...</p>
                </div>
                <div id="gratitude-board" class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-3 gap-6">
                    <!-- As notas de gratidão serão inseridas aqui pelo JavaScript -->
                </div>
                 <div id="empty-state" class="hidden text-center py-20 bg-white rounded-xl shadow-lg">
                    <i data-feather="coffee" class="mx-auto h-16 w-16 text-slate-400"></i>
                    <h3 class="mt-4 text-xl font-semibold text-slate-600">O mural está vazio!</h3>
                    <p class="mt-1 text-slate-500">Seja o primeiro a espalhar a gratidão na equipe.</p>
                </div>
            </div>
        </main>

    </div>

    <!-- Módulo JavaScript com a lógica do Firebase -->
    <script type="module">
        // Importações do Firebase SDK
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, serverTimestamp, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Configuração do Firebase (será preenchida pelo ambiente)
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'mural-gratidao-default';

        // Inicialização dos serviços do Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Referência à coleção de notas no Firestore
        const notesCollectionRef = collection(db, `/artifacts/${appId}/public/data/gratitude_notes`);

        // Elementos do DOM
        const form = document.getElementById('gratitudeForm');
        const board = document.getElementById('gratitude-board');
        const loadingDiv = document.getElementById('loading');
        const emptyStateDiv = document.getElementById('empty-state');
        const userInfoDiv = document.getElementById('userInfo');
        
        // Cores para os post-its
        const postItColors = [
            'bg-yellow-200', 'bg-green-200', 'bg-blue-200', 'bg-pink-200', 'bg-purple-200', 'bg-orange-200'
        ];
        // Rotações para os post-its
        const postItRotations = ['rotate-1', 'rotate-2', 'rotate-3', 'rotate-4', 'rotate-5'];

        let currentUserId = null;

        // Função para renderizar uma nota no mural
        const renderNote = (noteData) => {
            const docId = noteData.id;
            const note = noteData.data();

            const randomColor = postItColors[Math.floor(Math.random() * postItColors.length)];
            const randomRotation = postItRotations[Math.floor(Math.random() * postItRotations.length)];
            
            const noteEl = document.createElement('div');
            noteEl.className = `post-it p-6 rounded-lg flex flex-col h-full ${randomColor} ${randomRotation}`;
            noteEl.setAttribute('data-id', docId);

            let deleteButtonHTML = '';
            // Permite deletar apenas se o usuário for o criador da nota
            if (currentUserId && note.userId === currentUserId) {
                deleteButtonHTML = `<button data-id="${docId}" class="delete-btn absolute top-2 right-2 text-slate-500 hover:text-red-500 transition-colors">
                                        <i data-feather="x-circle" class="h-5 w-5"></i>
                                    </button>`;
            }

            noteEl.innerHTML = `
                <div class="relative">
                    <div class="font-handwriting text-3xl text-slate-700 break-words">Para: ${escapeHTML(note.to)}</div>
                    <p class="mt-4 text-slate-600 flex-grow break-words">${escapeHTML(note.message)}</p>
                    <div class="mt-4 pt-2 border-t border-slate-400/50 text-right">
                        <p class="text-sm font-semibold text-slate-700">De: ${escapeHTML(note.from)}</p>
                    </div>
                    ${deleteButtonHTML}
                </div>
            `;
            
            // Adiciona a nota no início do mural
            board.prepend(noteEl);
            feather.replace(); // Atualiza os ícones
        };

        // Função para escapar HTML e prevenir XSS
        const escapeHTML = (str) => {
            const p = document.createElement('p');
            p.appendChild(document.createTextNode(str));
            return p.innerHTML;
        }

        // Autenticação e carregamento dos dados
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUserId = user.uid;
                userInfoDiv.innerHTML = `Seu ID de Colaborador (compartilhe com sua equipe): <span class="font-mono bg-slate-200 text-slate-600 px-2 py-1 rounded">${currentUserId}</span>`;

                // Listener em tempo real para as notas
                onSnapshot(query(notesCollectionRef), (snapshot) => {
                    loadingDiv.style.display = 'none';
                    board.innerHTML = ''; // Limpa o mural antes de redesenhar
                    
                    if (snapshot.empty) {
                        emptyStateDiv.classList.remove('hidden');
                    } else {
                        emptyStateDiv.classList.add('hidden');
                        snapshot.docs.sort((a, b) => b.data().createdAt - a.data().createdAt).forEach(doc => {
                            renderNote({ id: doc.id, data: () => doc.data() });
                        });
                    }
                });
            }
        });

        // Lógica de autenticação
        const authenticate = async () => {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Erro na autenticação:", error);
                userInfoDiv.textContent = "Não foi possível conectar. Tente recarregar a página.";
            }
        };

        // Adicionar uma nova nota
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentUserId) {
                alert("Você precisa estar autenticado para postar.");
                return;
            }

            const fromInput = form.querySelector('#from');
            const toInput = form.querySelector('#to');
            const messageInput = form.querySelector('#message');
            
            const newNote = {
                from: fromInput.value,
                to: toInput.value,
                message: messageInput.value,
                createdAt: serverTimestamp(),
                userId: currentUserId
            };

            try {
                await addDoc(notesCollectionRef, newNote);
                form.reset(); // Limpa o formulário
            } catch (error) {
                console.error("Erro ao adicionar nota: ", error);
                alert("Ocorreu um erro ao salvar sua nota. Tente novamente.");
            }
        });
        
        // Deletar uma nota (usando delegação de evento)
        board.addEventListener('click', async (e) => {
            const deleteButton = e.target.closest('.delete-btn');
            if (deleteButton) {
                const docId = deleteButton.dataset.id;
                if (confirm("Tem certeza que deseja apagar esta nota?")) {
                    try {
                        const docRef = doc(db, `/artifacts/${appId}/public/data/gratitude_notes`, docId);
                        await deleteDoc(docRef);
                    } catch (error) {
                        console.error("Erro ao deletar nota:", error);
                        alert("Não foi possível apagar a nota.");
                    }
                }
            }
        });

        // Inicialização
        authenticate();
        feather.replace(); // Renderiza os ícones iniciais
    </script>
</body>
</html>
