<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mural de Recados Virtual</title>
    
    <!-- Tailwind CSS para estilização -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: Inter e Patrick Hand para um visual de post-it -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Patrick+Hand&display=swap" rel="stylesheet">

    <style>
        /* Estilos personalizados para complementar o Tailwind */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5; /* Um cinza claro para o fundo */
        }
        .font-patrick-hand {
            font-family: 'Patrick Hand', cursive;
        }
        /* Efeito de sombra e rotação para os post-its */
        .post-it {
            box-shadow: 5px 5px 7px rgba(33,33,33,.7);
            transition: transform 0.15s linear;
        }
        /* Rotações aleatórias para dar um ar mais natural */
        .post-it:nth-child(2n) { transform: rotate(4deg); }
        .post-it:nth-child(3n) { transform: rotate(-3deg); }
        .post-it:nth-child(4n) { transform: rotate(1deg); }
        .post-it:nth-child(5n) { transform: rotate(-2deg); }
        .post-it:hover {
            transform: scale(1.05);
            z-index: 10;
        }
        /* Estilo para a barra de rolagem */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="app" class="container mx-auto p-4 md:p-8">

        <!-- Cabeçalho -->
        <header class="text-center mb-8">
            <h1 class="text-4xl md:text-5xl font-bold text-gray-700">Mural de Recados da Equipe</h1>
            <p class="text-gray-500 mt-2">Deixe uma nota para seus colegas. As atualizações são em tempo real!</p>
        </header>

        <!-- Formulário para adicionar um novo recado -->
        <section id="form-section" class="mb-8 max-w-2xl mx-auto">
            <div class="bg-white rounded-lg shadow-lg p-6">
                <textarea id="note-text" class="w-full p-3 border-2 border-gray-200 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-400 transition" rows="4" placeholder="Escreva seu recado aqui..."></textarea>
                <div class="flex flex-col sm:flex-row items-center justify-between mt-4">
                    <div class="flex items-center mb-4 sm:mb-0">
                        <label for="note-color" class="mr-3 font-medium text-gray-600">Cor:</label>
                        <div class="flex space-x-2">
                            <!-- Opções de cores para os post-its -->
                            <div class="color-option w-8 h-8 rounded-full cursor-pointer bg-yellow-200 border-2 border-yellow-400" data-color="bg-yellow-200"></div>
                            <div class="color-option w-8 h-8 rounded-full cursor-pointer bg-green-200" data-color="bg-green-200"></div>
                            <div class="color-option w-8 h-8 rounded-full cursor-pointer bg-blue-200" data-color="bg-blue-200"></div>
                            <div class="color-option w-8 h-8 rounded-full cursor-pointer bg-pink-200" data-color="bg-pink-200"></div>
                            <div class="color-option w-8 h-8 rounded-full cursor-pointer bg-purple-200" data-color="bg-purple-200"></div>
                        </div>
                        <input type="hidden" id="note-color-value" value="bg-yellow-200">
                    </div>
                    <button id="add-note-btn" class="w-full sm:w-auto bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-6 rounded-lg shadow-md transition-transform transform hover:scale-105">
                        Adicionar Recado
                    </button>
                </div>
            </div>
        </section>

        <!-- Seção onde os recados são exibidos -->
        <main id="notes-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
            <!-- Os recados do Firestore serão inseridos aqui -->
            <div id="loading-indicator" class="col-span-full text-center text-gray-500">
                <p>Carregando recados...</p>
            </div>
        </main>

        <!-- Rodapé com informações de colaboração -->
        <footer class="text-center mt-12 text-gray-500">
            <p>Seu ID de usuário é: <strong id="user-id-display" class="select-all">...</strong></p>
            <p class="text-sm mt-1">Compartilhe esta página para que outros possam ver e adicionar recados.</p>
        </footer>

    </div>

    <!-- Módulos do Firebase -->
    <script type="module">
        // Importações necessárias do SDK do Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, deleteDoc, doc, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Configuração do Firebase ---
        // As variáveis __firebase_config, __app_id e __initial_auth_token são injetadas pelo ambiente.
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'mural-de-recados-default';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db, auth, userId;

        // --- Elementos do DOM ---
        const addNoteBtn = document.getElementById('add-note-btn');
        const noteText = document.getElementById('note-text');
        const noteColorValue = document.getElementById('note-color-value');
        const notesGrid = document.getElementById('notes-grid');
        const loadingIndicator = document.getElementById('loading-indicator');
        const userIdDisplay = document.getElementById('user-id-display');
        const colorOptions = document.querySelectorAll('.color-option');

        // --- Funções Principais ---

        /**
         * Inicializa o Firebase e configura a autenticação e o listener de recados.
         */
        async function initializeAppAndAuth() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        userIdDisplay.textContent = userId;
                        console.log("Usuário autenticado:", userId);
                        // Após autenticar, começa a ouvir os recados
                        listenForNotes();
                    } else {
                        console.log("Nenhum usuário autenticado.");
                        userIdDisplay.textContent = "Não autenticado";
                    }
                });
                
                // Tenta autenticar com o token customizado ou de forma anônima
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

            } catch (error) {
                console.error("Erro ao inicializar o Firebase:", error);
                notesGrid.innerHTML = '<p class="text-red-500 col-span-full text-center">Erro ao conectar com o serviço. Tente recarregar a página.</p>';
            }
        }

        /**
         * Ouve as mudanças na coleção de recados do Firestore em tempo real.
         */
        function listenForNotes() {
            // Caminho para a coleção pública de recados
            const notesCollectionPath = `/artifacts/${appId}/public/data/notes`;
            const notesCollection = collection(db, notesCollectionPath);
            // Cria uma query para ordenar os recados por data de criação
            const q = query(notesCollection, orderBy("timestamp", "desc"));

            onSnapshot(q, (snapshot) => {
                loadingIndicator.style.display = 'none';
                notesGrid.innerHTML = ''; // Limpa o grid antes de adicionar os novos recados
                if (snapshot.empty) {
                    notesGrid.innerHTML = '<p class="col-span-full text-center text-gray-500">Nenhum recado ainda. Seja o primeiro!</p>';
                } else {
                    snapshot.forEach(doc => {
                        const note = doc.data();
                        const noteElement = createNoteElement(doc.id, note.text, note.color, note.userId);
                        notesGrid.appendChild(noteElement);
                    });
                }
            }, (error) => {
                console.error("Erro ao buscar recados:", error);
                notesGrid.innerHTML = '<p class="text-red-500 col-span-full text-center">Não foi possível carregar os recados.</p>';
            });
        }

        /**
         * Cria o elemento HTML para um recado (post-it).
         * @param {string} id - O ID do documento no Firestore.
         * @param {string} text - O texto do recado.
         * @param {string} colorClass - A classe de cor do Tailwind CSS.
         * @param {string} authorId - O ID do usuário que criou o recado.
         * @returns {HTMLElement} O elemento div do recado.
         */
        function createNoteElement(id, text, colorClass, authorId) {
            const noteDiv = document.createElement('div');
            noteDiv.className = `post-it p-4 rounded-md flex flex-col justify-between min-h-[150px] ${colorClass}`;
            
            // Usamos a fonte especial para o texto do recado
            const textP = document.createElement('p');
            textP.className = 'font-patrick-hand text-2xl text-gray-800 break-words flex-grow';
            textP.textContent = text;
            
            const footerDiv = document.createElement('div');
            footerDiv.className = 'flex justify-end items-center mt-2';

            // Botão para deletar o recado
            const deleteBtn = document.createElement('button');
            deleteBtn.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-trash text-gray-600 hover:text-red-500 transition-colors" viewBox="0 0 16 16">
                    <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0z"/>
                    <path d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4zM2.5 3h11V2h-11z"/>
                </svg>
            `;
            deleteBtn.title = "Apagar recado";
            deleteBtn.onclick = () => deleteNote(id);
            
            footerDiv.appendChild(deleteBtn);
            noteDiv.appendChild(textP);
            noteDiv.appendChild(footerDiv);

            return noteDiv;
        }

        /**
         * Adiciona um novo recado ao Firestore.
         */
        async function addNote() {
            const text = noteText.value.trim();
            const color = noteColorValue.value;

            if (!text) {
                alert("Por favor, escreva um recado.");
                return;
            }
            if (!userId) {
                alert("Autenticação pendente, por favor aguarde.");
                return;
            }

            try {
                const notesCollectionPath = `/artifacts/${appId}/public/data/notes`;
                await addDoc(collection(db, notesCollectionPath), {
                    text: text,
                    color: color,
                    userId: userId,
                    timestamp: serverTimestamp() // Usa o timestamp do servidor para ordenação
                });
                // Limpa os campos após o envio
                noteText.value = '';
            } catch (error) {
                console.error("Erro ao adicionar recado: ", error);
                alert("Não foi possível adicionar o recado. Tente novamente.");
            }
        }

        /**
         * Deleta um recado do Firestore.
         * @param {string} id - O ID do documento a ser deletado.
         */
        async function deleteNote(id) {
            if (confirm("Tem certeza que deseja apagar este recado?")) {
                try {
                    const noteDocPath = `/artifacts/${appId}/public/data/notes/${id}`;
                    await deleteDoc(doc(db, noteDocPath));
                } catch (error) {
                    console.error("Erro ao deletar recado: ", error);
                    alert("Não foi possível apagar o recado.");
                }
            }
        }

        /**
         * Lida com a seleção de cor.
         * @param {Event} e - O evento de clique.
         */
        function handleColorSelection(e) {
            const selectedColor = e.target.dataset.color;
            if (!selectedColor) return;

            noteColorValue.value = selectedColor;

            // Atualiza o visual da seleção
            colorOptions.forEach(opt => {
                opt.classList.remove('border-2', 'border-gray-700', 'ring-2', 'ring-offset-2', 'ring-blue-400');
                if(opt.dataset.color === selectedColor) {
                    opt.classList.add('ring-2', 'ring-offset-2', 'ring-blue-400');
                }
            });
        }


        // --- Event Listeners ---
        addNoteBtn.addEventListener('click', addNote);
        document.querySelector('.flex.space-x-2').addEventListener('click', handleColorSelection);
        
        // --- Inicialização ---
        document.addEventListener('DOMContentLoaded', () => {
            initializeAppAndAuth();
            // Define a cor inicial visualmente
            document.querySelector(`[data-color="${noteColorValue.value}"]`).classList.add('ring-2', 'ring-offset-2', 'ring-blue-400');
        });

    </script>